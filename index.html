<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HABIT TIMER</title>

  <style>
    :root{
      /* PAPER + INK */
      --paper:   #f3ead8;     /* beige */
      --paper2:  #efe2cb;
      --ink:     #0b0b0b;
      --muted:   #5b5b5b;
      --rule:    rgba(11,11,11,0.16);

      /* ACCENT */
      --accent:  #e10600;     /* swiss red */

      /* SURFACES */
      --glass:       rgba(255,255,255,0.38);
      --glass-strong:rgba(255,255,255,0.58);

      /* SHAPE */
      --radius:  12px;        /* slightly sharp */
      --shadow:  0 18px 60px rgba(0,0,0,0.10);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(0,0,0,0.05), transparent 55%),
        radial-gradient(1200px 700px at 90% 0%, rgba(225,6,0,0.06), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      max-width: 980px;
      margin: 18px auto;
      padding: 0 14px calc(118px + env(safe-area-inset-bottom));
    }

    /* HEADER */
    h1{
      margin: 0 0 6px;
      font-weight: 950;
      letter-spacing: -0.05em;
      text-transform: uppercase;
      font-size: 24px;
      line-height: 1.02;
    }
    .sub{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .sub b{ color: var(--ink); }

    /* LAYOUT */
    .card{
      border: 1px solid var(--rule);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(7px);
      padding: 14px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    .row{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
      margin: 0;
    }
    .right{
      margin-left:auto;
      text-align:right;
    }

    .label{
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 900;
    }

    .pill{
      display:inline-flex;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 8px 12px;
      border: 1px solid var(--rule);
      border-radius: 999px;
      background: rgba(255,255,255,0.42);
      font-weight: 900;
      letter-spacing: -0.01em;
      text-transform: uppercase;
    }

    .timer{
      font-size: 58px;
      font-weight: 980;
      letter-spacing: -0.06em;
      line-height: 0.95;
    }

    /* BUTTONS */
    button{
      border: 1px solid var(--rule);
      background: rgba(255,255,255,0.35);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 950;
      letter-spacing: -0.01em;
      text-transform: uppercase;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .03s ease, background .15s ease, border-color .15s ease;
    }
    button:active{ transform: scale(0.99); }
    button:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }

    button.primary{
      background: var(--ink);
      border-color: var(--ink);
      color: var(--paper);
    }
    button.danger{
      background: rgba(225,6,0,0.12);
      border-color: rgba(225,6,0,0.25);
      color: var(--accent);
    }

    /* TOP ACTIONS */
    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .spacer{ flex: 1; }
    #status{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 900;
      white-space: nowrap;
    }

    /* TOTALS */
    #totals{
      margin-top: 8px;
      color: var(--ink);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }
    #totals div{
      border-top: 1px dashed var(--rule);
      padding-top: 8px;
      margin-top: 8px;
      font-weight: 850;
    }

    /* TABLE */
    table{ width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td{ padding: 12px 8px; border-bottom: 1px solid var(--rule); vertical-align: middle; }
    th{
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }

    /* BOTTOM THUMB BAR */
    .bottomBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(243,234,216,0.86);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--rule);
      z-index: 9990;
    }
    .bottomBarInner{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .bottomBar button{
      padding: 14px 12px;
      border-radius: 16px;
      font-size: 16px;
    }
    .bottomBar button.primary{
      position: relative;
    }
    .bottomBar button.primary::after{
      content:"";
      position:absolute;
      left: 12px; right: 12px; bottom: 10px;
      height: 2px;
      background: var(--accent);
      opacity: 0.95;
      border-radius: 2px;
    }

    /* ACTIVITY SHEET */
    .overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,0.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px;
      z-index: 9999;
    }
    .sheet{
      width: min(980px, 100%);
      background: var(--glass-strong);
      border: 1px solid var(--rule);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
      max-height: 80vh;
      overflow:auto;
      backdrop-filter: blur(12px);
    }
    .sheetHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .sheetTitle{
      margin:0;
      font-size: 11px;
      letter-spacing: 0.20em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .sheetHint{
      margin: 6px 0 0;
      color: var(--ink);
      font-weight: 980;
      letter-spacing: -0.04em;
      font-size: 20px;
      line-height: 1.10;
      text-transform: uppercase;
    }
    .sheetHint em{
      font-style: normal;
      color: var(--accent);
    }

    .activityInput{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid var(--rule);
      background: rgba(255,255,255,0.5);
      color: var(--ink);
      font-size: 16px;
      outline:none;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: -0.01em;
    }

    .chips{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px; }
    .chip{
      background: rgba(255,255,255,0.5);
      border: 1px solid var(--rule);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 980;
      letter-spacing: -0.01em;
      text-transform: uppercase;
    }
    .chip:hover{ background: rgba(255,255,255,0.7); }

    .sheetActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    .sheetActions button{
      padding: 14px 12px;
      border-radius: 16px;
    }

    /* SMALL SCREEN TABLE SIMPLIFICATION */
    @media (max-width: 560px){
      th:nth-child(2), td:nth-child(2),
      th:nth-child(3), td:nth-child(3){ display:none; }
      th:nth-child(4), td:nth-child(4){ width: 120px; }
    }
    @media (min-width: 720px){
      .timer{ font-size: 68px; }
      .overlay{ align-items:center; padding: 16px; }
      .sheet{ max-height: 70vh; }
    }
  </style>
</head>

<body>
  <h1>HABIT TIMER</h1>
  <p class="sub">TRACK WHAT YOU DO + HOW LONG IT TAKES. USE <b>NEXT</b> TO ROLL OVER INSTANTLY.</p>

  <div class="card">
    <div class="row">
      <div>
        <div class="label">CURRENT</div>
        <div id="currentActivity" class="pill">—</div>
      </div>
      <div class="right">
        <div class="label">TIMER</div>
        <div id="timer" class="timer">00:00:00</div>
      </div>
    </div>

    <div class="topActions">
      <button id="exportBtn">EXPORT CSV</button>
      <button id="clearTodayBtn" class="danger">CLEAR TODAY</button>
      <span class="spacer"></span>
      <span id="status"></span>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="label">TODAY TOTALS</div>
    <div id="totals">NO ENTRIES YET.</div>

    <table>
      <thead>
        <tr>
          <th>ACTIVITY</th>
          <th>START</th>
          <th>END</th>
          <th>DURATION</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>

  <!-- Bottom thumb controls -->
  <div class="bottomBar">
    <div class="bottomBarInner">
      <button id="startBtn" class="primary">START</button>
      <button id="nextBtn" disabled>NEXT</button>
      <button id="endBtn" disabled class="danger">END</button>
    </div>
  </div>

  <!-- Activity sheet -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div>
          <p class="sheetTitle">NEW BLOCK</p>
          <p class="sheetHint">WHAT ARE YOU DOING <em>RIGHT NOW</em>?</p>
        </div>
        <button id="cancelModalBtn">CLOSE</button>
      </div>

      <input id="activityInput" class="activityInput" type="text" placeholder="EDITING / GYM / SCROLLING" autocomplete="off" />
      <div id="chips" class="chips"></div>

      <div class="sheetActions">
        <button id="startModalBtn" class="primary">START</button>
        <button id="clearInputBtn">CLEAR</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const ENTRIES_KEY = "habit_timer_entries_poster_v1";
  const RECENTS_KEY = "habit_timer_recent_activities_v1";
  const ACTIVE_KEY  = "habit_timer_active_task_v1";
  const MAX_RECENTS = 12;

  const $ = (id) => document.getElementById(id);

  const startBtn = $("startBtn");
  const endBtn = $("endBtn");
  const nextBtn = $("nextBtn");
  const exportBtn = $("exportBtn");
  const clearTodayBtn = $("clearTodayBtn");

  const timerEl = $("timer");
  const currentActivityEl = $("currentActivity");
  const logBody = $("logBody");
  const totalsEl = $("totals");
  const statusEl = $("status");

  // Sheet
  const overlay = $("overlay");
  const activityInput = $("activityInput");
  const chipsEl = $("chips");
  const cancelModalBtn = $("cancelModalBtn");
  const startModalBtn = $("startModalBtn");
  const clearInputBtn = $("clearInputBtn");

  let running = false;
  let startTs = null;
  let currentActivity = null;
  let tickHandle = null;

  function pad(n) { return String(n).padStart(2, "0"); }

  function formatHMS(ms) {
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function toLocalTimeString(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function toLocalTimeShort(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function todayKey(ts = Date.now()) {
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    return `${y}-${m}-${day}`;
  }

  function loadJSON(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }

  function saveJSON(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function removeKey(key) {
    localStorage.removeItem(key);
  }

  function loadEntries() { return loadJSON(ENTRIES_KEY, []); }
  function saveEntries(entries) { saveJSON(ENTRIES_KEY, entries); }

  function getTodayEntries() {
    const tKey = todayKey();
    return loadEntries().filter(e => e.day === tKey);
  }

  function addEntry(entry) {
    const entries = loadEntries();
    entries.push(entry);
    saveEntries(entries);
  }

  function deleteEntry(id) {
    saveEntries(loadEntries().filter(e => e.id !== id));
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setUiState(isRunning) {
    startBtn.disabled = isRunning;
    endBtn.disabled = !isRunning;
    nextBtn.disabled = !isRunning;

    if (!isRunning) {
      currentActivityEl.textContent = "—";
      timerEl.textContent = "00:00:00";
    }
  }

  function tick() {
    const elapsed = Date.now() - startTs;
    timerEl.textContent = formatHMS(elapsed);
  }

  // ---- Recents ----
  function loadRecents() {
    return loadJSON(RECENTS_KEY, []);
  }

  function updateRecents(activity) {
    const a = activity.trim();
    if (!a) return;
    const recents = loadRecents().filter(x => x.toLowerCase() !== a.toLowerCase());
    recents.unshift(a);
    saveJSON(RECENTS_KEY, recents.slice(0, MAX_RECENTS));
  }

  function renderRecentsChips() {
    const recents = loadRecents();
    chipsEl.innerHTML = "";

    if (recents.length === 0) {
      const hint = document.createElement("div");
      hint.style.color = "rgba(11,11,11,0.7)";
      hint.style.fontWeight = "900";
      hint.style.textTransform = "uppercase";
      hint.style.letterSpacing = "0.08em";
      hint.style.marginTop = "10px";
      hint.textContent = "NO RECENTS YET. START A TASK ONCE.";
      chipsEl.appendChild(hint);
      return;
    }

    for (const act of recents) {
      const btn = document.createElement("button");
      btn.className = "chip";
      btn.type = "button";
      btn.textContent = act;
      btn.addEventListener("click", () => {
        closeSheet();
        startTimerWithActivity(act);
      });
      chipsEl.appendChild(btn);
    }
  }

  // ---- Active task persistence (Resume) ----
  function saveActiveTask() {
    if (!running) return;
    saveJSON(ACTIVE_KEY, { activity: currentActivity, startTs });
  }
  function clearActiveTask() { removeKey(ACTIVE_KEY); }
  function loadActiveTask() { return loadJSON(ACTIVE_KEY, null); }

  function maybeResumeActiveTask() {
    const active = loadActiveTask();
    if (!active || !active.activity || !active.startTs) return;
    if (running) return;

    const startedAt = toLocalTimeShort(active.startTs);
    const ok = confirm(`RESUME "${active.activity}" STARTED AT ${startedAt}?`);
    if (!ok) { clearActiveTask(); return; }

    running = true;
    currentActivity = String(active.activity);
    startTs = Number(active.startTs);

    currentActivityEl.textContent = currentActivity;
    statusEl.textContent = "RESUMED";
    setUiState(true);

    tick();
    tickHandle = setInterval(tick, 250);
  }

  // ---- Sheet ----
  function openSheet() {
    renderRecentsChips();
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden", "false");
    activityInput.value = "";
    setTimeout(() => activityInput.focus(), 0);
  }

  function closeSheet() {
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
  }

  function submitSheet() {
    const name = (activityInput.value || "").trim();
    if (!name) return;
    closeSheet();
    startTimerWithActivity(name);
  }

  activityInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitSheet();
    if (e.key === "Escape") closeSheet();
  });

  cancelModalBtn.addEventListener("click", closeSheet);
  startModalBtn.addEventListener("click", submitSheet);
  clearInputBtn.addEventListener("click", () => { activityInput.value = ""; activityInput.focus(); });

  // ---- Timer actions ----
  function startTimerWithActivity(name) {
    if (running) return;

    running = true;
    currentActivity = name.trim().toUpperCase();
    startTs = Date.now();

    currentActivityEl.textContent = currentActivity;
    statusEl.textContent = "";
    setUiState(true);

    saveActiveTask();

    tick();
    tickHandle = setInterval(tick, 250);
  }

  function stopAndSave({ silentTooShort = true } = {}) {
    if (!running) return;

    const endTs = Date.now();
    const durationMs = endTs - startTs;

    clearInterval(tickHandle);
    tickHandle = null;

    if (durationMs < 2000) {
      if (!silentTooShort) statusEl.textContent = "IGNORED (TOO SHORT)";
    } else {
      addEntry({
        id: crypto.randomUUID(),
        day: todayKey(startTs),
        activity: currentActivity,
        startTs,
        endTs,
        durationMs
      });
      updateRecents(currentActivity);
      statusEl.textContent = "SAVED";
    }

    running = false;
    startTs = null;
    currentActivity = null;

    clearActiveTask();

    setUiState(false);
    render();
  }

  function nextTask() {
    stopAndSave({ silentTooShort: false });
    openSheet();
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") saveActiveTask();
  });
  window.addEventListener("beforeunload", () => { saveActiveTask(); });

  // ---- Render log ----
  function render() {
    const entries = getTodayEntries().sort((a,b) => a.startTs - b.startTs);

    logBody.innerHTML = "";
    for (const e of entries) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="pill">${escapeHtml(e.activity)}</span></td>
        <td>${toLocalTimeString(e.startTs)}</td>
        <td>${toLocalTimeString(e.endTs)}</td>
        <td style="font-weight:950; letter-spacing:-0.03em;">${formatHMS(e.durationMs)}</td>
        <td><button data-del="${e.id}">DELETE</button></td>
      `;
      logBody.appendChild(tr);
    }

    logBody.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        deleteEntry(btn.getAttribute("data-del"));
        render();
      });
    });

    const totals = new Map();
    for (const e of entries) totals.set(e.activity, (totals.get(e.activity) || 0) + e.durationMs);

    if (totals.size === 0) {
      totalsEl.textContent = "NO ENTRIES YET.";
    } else {
      const lines = [...totals.entries()]
        .sort((a,b) => b[1]-a[1])
        .map(([act, ms]) => `${act}: ${formatHMS(ms)}`);
      totalsEl.innerHTML = lines.map(l => `<div>${escapeHtml(l)}</div>`).join("");
    }
  }

  // ---- Export/Clear ----
  function exportCSV() {
    const entries = loadEntries().sort((a,b) => a.startTs - b.startTs);
    const header = ["day","activity","start","end","duration_seconds"].join(",");
    const rows = entries.map(e => ([
      e.day,
      `"${String(e.activity).replaceAll('"','""')}"`,
      new Date(e.startTs).toISOString(),
      new Date(e.endTs).toISOString(),
      Math.round(e.durationMs / 1000)
    ].join(",")));

    const csv = [header, ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "habit-timer-export.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearToday() {
    const tKey = todayKey();
    saveEntries(loadEntries().filter(e => e.day !== tKey));
    render();
  }

  // wiring
  startBtn.addEventListener("click", openSheet);
  endBtn.addEventListener("click", () => stopAndSave({ silentTooShort: false }));
  nextBtn.addEventListener("click", nextTask);
  exportBtn.addEventListener("click", exportCSV);
  clearTodayBtn.addEventListener("click", clearToday);

  // init
  setUiState(false);
  render();
  maybeResumeActiveTask();
})();
</script>
</body>
</html>
